<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduVillage | Teacher Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family: Arial, sans-serif;}
body{display:flex;height:100vh;background: linear-gradient(135deg, #6e45e2, #88d3ce);}
.sidebar{width:240px;background:#472e9f;color:white;padding:20px;}
.sidebar h2{text-align:center;margin-bottom:30px;font-family:"Lucida Handwriting";}
.sidebar button{width:100%;padding:12px;margin:6px 0;border:none;background:#755dca;color:black;cursor:pointer;text-align:left;border-radius:5px;transition:0.3s;}
.sidebar button:hover{background:#2a165f;color:white;}
.main{flex:1;padding:30px;overflow-y:auto;}
.section{display:none;background:linear-gradient(135deg,#baa9c5,#88d3ce);padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 10px rgba(0,0,0,0.2);}
.section.active{display:block;}
input, textarea{width:100%;padding:10px;margin:8px 0;border-radius:5px;border:1px solid #444;}
button.action{padding:8px 15px;background:#755dca;border:none;border-radius:5px;cursor:pointer;}
button.action:hover{background:#2a165f;color:white;}
h3{margin-bottom:10px;}
li{margin:5px 0;}
li button{margin-left:10px;padding:3px 6px;background:#2a165f;color:white;border:none;border-radius:3px;cursor:pointer;}
li button:hover{background:#755dca;}
</style>
</head>
<body>

<div class="sidebar">
    <h2>EduVillage</h2>
    <button onclick="showSection('profile')">Profile</button>
    <button onclick="showSection('courses')">Manage Courses</button>
    <button onclick="showSection('assignment')">Create Assignment</button>
    <button onclick="showSection('notes')">Upload Notes</button>
    <button onclick="openStudents()">View Students</button>

    <button onclick="logout()">Logout</button>
</div>

<div class="main">
    <!-- PROFILE -->
    <div id="profile" class="section active">
        <h3>Teacher Profile</h3>
        <p><b>Name:</b> <span id="teacherName"></span></p>
        <p><b>Email:</b> <span id="teacherEmail"></span></p>
    </div>

    <!-- COURSES -->
    <div id="courses" class="section">
    <h3>Manage Courses</h3>

    <input type="text" id="courseName" placeholder="Enter Course Name">

    <button 
        id="addCourseBtn" 
        class="action" 
        onclick="addCourse()">
        Add Course
    </button>

    <ul id="courseList"></ul>
</div>

    <!-- ASSIGNMENTS -->
<div id="assignment" class="section">
    <h3>Create Assignment</h3>

    <!-- âœ… ADD DROPDOWN HERE -->
    <select id="assignmentCourse">
        <option value="">Select Course</option>
    </select>

    <input type="text" id="assignmentTitle" placeholder="Assignment Title">
    <textarea id="assignmentDesc" placeholder="Assignment Description"></textarea>

    <button
        id="createAssignmentBtn"
        class="action"
        onclick="createAssignment()">
        Create Assignment
    </button>

    <ul id="assignmentList"></ul>
</div>
    <!-- NOTES -->
    <div id="notes" class="section">
    <h3>Upload Notes</h3>
    
    <select id="noteCourse" style="width: 100%; padding: 10px; margin-bottom: 10px;">
        <option value="">Select Course</option>
    </select>

    <input type="text" id="noteDescription" placeholder="Enter Note Title (e.g., Web Development)" 
           style="width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box;">

    <textarea id="notesText" rows="6" placeholder="Enter detailed notes content..." 
              style="width: 100%; padding: 10px; box-sizing: border-box;"></textarea>
    
    <br><br>
    
    <button class="action" onclick="saveNotes()">Save Notes</button>
</div>
    <!-- STUDENTS -->
    <div id="students" class="section">
        <h3>Students List</h3>
        <ul id="studentList"></ul>
    </div>
</div>

<script>
// ---------- SECTION SWITCH ----------
/* ================= UPDATED SECTION SWITCH ================= */
function showSection(id){
    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    // âœ… Add this line:
    if (id === 'notes') loadCoursesForNotes(); 
    
    // (Keep your existing assignment loader if you have it)
    if (id === 'assignment') loadCoursesForAssignment();
}
// ---------- LOAD TEACHER PROFILE ----------
document.getElementById("teacherName").innerText = localStorage.getItem("teacherName") || "Teacher";
document.getElementById("teacherEmail").innerText = localStorage.getItem("teacherEmail") || "Not Available";

// ---------- COURSES ----------
async function addCourse() {
    const name = document.getElementById("courseName").value.trim();
    const teacherId = localStorage.getItem("teacherId");

    if (!teacherId) {
        alert("Please login again");
        window.location.href = "login_register.html";
        return;
    }

    if (!name) {
        alert("Enter course name");
        return;
    }

    const res = await fetch("http://localhost:3000/course/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            course_name: name,
            teacher_id: teacherId
        })
    });

    const data = await res.json();

    if (data.success) {
        alert("Course added successfully");
        document.getElementById("courseName").value = "";
        loadCourses(); // ðŸ”¥ disables button
    } else {
        alert(data.message || "Cannot add course");
    }
}

async function loadCourses() {
    const teacherId = localStorage.getItem("teacherId");
    const addBtn = document.getElementById("addCourseBtn");

    if (!teacherId) {
        addBtn.disabled = true;
        return;
    }

    const res = await fetch(`http://localhost:3000/courses/teacher/${teacherId}`);
    const data = await res.json();

    console.log("API DATA:", data); // DEBUG

    if (data.success && data.courses.length > 0) {
        addBtn.disabled = true;
        addBtn.innerText = "Course Already Added";
        addBtn.style.opacity = "0.6";
    } else {
        addBtn.disabled = false;
        addBtn.innerText = "Add Course";
    }
}

// ---------- ASSIGNMENTS ----------
// ---------- CREATE ASSIGNMENT ----------
async function createAssignment() {
    const title = document.getElementById("assignmentTitle").value.trim();
    const description = document.getElementById("assignmentDesc").value.trim();
    const course_id = document.getElementById("assignmentCourse").value;
    const teacherName = localStorage.getItem("teacherName");

    if (!title || !course_id) {
        alert("Fill all fields");
        return;
    }

    const res = await fetch("http://localhost:3000/assignment/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            title,
            description,
            course_id,        // âœ… MATCHES BACKEND
            teacher_name: teacherName
        })
    });

    const data = await res.json();

    if (data.success) {
        alert("Assignment created");
        document.getElementById("assignmentTitle").value = "";
        document.getElementById("assignmentDesc").value = "";
        document.getElementById("assignmentCourse").value = "";
    } else {
        alert(data.message || "Error creating assignment");
    }
}


// ---------- LOAD ASSIGNMENTS ----------
async function loadAssignments() {
    const teacherName = localStorage.getItem("teacherName");

    const res = await fetch(`http://localhost:3000/assignments/${teacherName}`);
    const data = await res.json();

    const ul = document.getElementById("assignmentList");
    ul.innerHTML = "";

    if (data.success) {
        data.assignments.forEach(a => {
            const li = document.createElement("li");
            li.innerHTML = `<b>${a.title}</b> (${a.course_name})<br>${a.description}`;
            ul.appendChild(li);
        });
    }
}
/* ================= UPDATED LOAD COURSES FOR ASSIGNMENT ================= */
async function loadCoursesForAssignment() {
    const teacherId = localStorage.getItem("teacherId");
    const select = document.getElementById("assignmentCourse");

    // Check if element exists to avoid errors
    if (!select) return;

    // Safety Check: If not logged in properly
    if (!teacherId) {
        select.innerHTML = `<option value="">Error: Please Logout & Login again</option>`;
        return;
    }

    // Show loading state
    select.innerHTML = `<option value="">Loading courses...</option>`;

    try {
        const res = await fetch(`http://localhost:3000/courses/teacher/${teacherId}`);
        const data = await res.json();

        // Clear and reset
        select.innerHTML = `<option value="">Select Course</option>`;

        if (data.success && data.courses.length > 0) {
            data.courses.forEach(course => {
                const opt = document.createElement("option");
                opt.value = course.id;           // This sends the ID to the backend
                opt.textContent = course.course_name;
                select.appendChild(opt);
            });
        } else {
            // Tell user if they haven't added courses yet
            const opt = document.createElement("option");
            opt.textContent = "No courses found (Add a course first)";
            select.appendChild(opt);
        }
    } catch (err) {
        console.error("API Error:", err);
        select.innerHTML = `<option value="">Server Error</option>`;
    }
}
// ---------- NOTES ----------
function saveNotes(){
    const notes = document.getElementById("notesText").value.trim();
    const teacherName = localStorage.getItem("teacherName");

    if(notes === ""){
        alert("Enter notes");
        return;
    }

    fetch("http://localhost:3000/notes", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            teacherName: teacherName,
            content: notes
        })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            alert("Notes saved to database!");
            document.getElementById("notesText").value = "";
        } else {
            alert("Error saving notes");
        }
    });
}


// ---------- STUDENTS ----------

async function loadStudents(){
    const res = await fetch("http://localhost:3000/students");
    const data = await res.json();

    const ul = document.getElementById("studentList");
    ul.innerHTML = "";

    if(data.success){
        data.students.forEach(s => {
            const li = document.createElement("li");
            li.innerText = `${s.name} â€“ ${s.email}`;
            ul.appendChild(li);
        });
    } else {
        ul.innerHTML = "<li>Error loading students</li>";
    }
}

/* ================= VIEW STUDENTS SECTION ================= */

function openStudents(){
    showSection('students');
    loadStudents(); 
}

async function loadStudents() {
    const teacherId = localStorage.getItem("teacherId");
    const ul = document.getElementById("studentList");

    // 1. Check if teacher is logged in
    if (!teacherId) {
        ul.innerHTML = "<li style='color:red;'>Error: Please logout and login again.</li>";
        return;
    }

    ul.innerHTML = "<li>Loading student list...</li>";

    try {
        // 2. Fetch students specifically for this teacher
        const res = await fetch(`http://localhost:3000/students/teacher/${teacherId}`);
        const data = await res.json();

        ul.innerHTML = "";

        // 3. Display the list
        if (data.success && data.students.length > 0) {
            data.students.forEach(s => {
                const li = document.createElement("li");
                
                // Show Name, Email, and Course
                li.innerHTML = `
                    <div style="padding: 10px; border-bottom: 1px solid #ccc;">
                        <strong>${s.student_name}</strong>
                        <br>
                        <span style="color: #555; font-size: 0.9em;">${s.email}</span>
                        <br>
                        <span style="background-color: #d1c4e9; color: #311b92; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;">
                            Course: ${s.course_name}
                        </span>
                    </div>
                `;
                ul.appendChild(li);
            });
        } else {
            ul.innerHTML = "<li style='padding:10px;'>No students enrolled in your courses yet.</li>";
        }
    } catch (err) {
        console.error("Error loading students:", err);
        ul.innerHTML = "<li style='color:red;'>Server error loading students.</li>";
    }
}

// ---------- LOGOUT ----------
function logout(){
    localStorage.clear();
    window.location.href = "login_register.html";
}
/* ================= 1. LOAD COURSES INTO NOTES DROPDOWN ================= */
async function loadCoursesForNotes() {
    const teacherId = localStorage.getItem("teacherId");
    const select = document.getElementById("noteCourse");
    
    // Safety check: if the dropdown doesn't exist in HTML, stop
    if (!select) return;

    select.innerHTML = '<option value="">Loading...</option>';

    // Fetch courses for this teacher
    const res = await fetch(`http://localhost:3000/courses/teacher/${teacherId}`);
    const data = await res.json();

    // Reset dropdown
    select.innerHTML = '<option value="">Select Course</option>';
    
    // Fill dropdown with courses
    if (data.success) {
        data.courses.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.id;            // This sends the ID (e.g., 5)
            opt.textContent = c.course_name; // This shows the Name (e.g., Math)
            select.appendChild(opt);
        });
    }
}

/* ================= 2. SAVE NOTES (With Course ID) ================= */
/* ================= SAVE NOTES (FINAL FIX) ================= */
async function saveNotes() {
    // 1. Get Elements
    const courseSelect = document.getElementById("noteCourse");
    const descInput = document.getElementById("noteDescription");
    const contentInput = document.getElementById("notesText");

    // 2. Safety Check (Debugs if HTML is wrong)
    if (!courseSelect || !descInput || !contentInput) {
        alert("CRITICAL ERROR: Input boxes are missing from HTML.");
        return;
    }

    // 3. Get Data
    const courseId = courseSelect.value;
    const description = descInput.value.trim();
    const notes = contentInput.value.trim();
    const teacherName = localStorage.getItem("teacherName");

    // 4. Validate
    if (courseId === "" || description === "" || notes === "") {
        alert("Please fill in Course, Title, and Content.");
        return;
    }

    // 5. Send to Server (USING FULL LOCALHOST URL)
    try {
        const res = await fetch("http://localhost:3000/notes", { 
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                teacherName: teacherName,
                content: notes,
                description: description,
                course_id: courseId
            })
        });

        const data = await res.json();
        
        if (data.success) {
            alert("âœ… Notes saved successfully!");
            descInput.value = "";
            contentInput.value = "";
        } else {
            alert("âŒ Server Error: " + data.message);
        }
    } catch (err) {
        console.error(err);
        alert("âŒ Network Error: Is 'node server.js' running?");
    }
}
// ---------- INITIAL LOAD ----------
window.addEventListener("DOMContentLoaded", () => {
    loadCourses();
    loadCoursesForAssignment(); // âœ… REQUIRED
});


</script>
</body>
</html>